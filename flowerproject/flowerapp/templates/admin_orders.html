<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Orders</title>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg:         #f4f1ec;
            --surface:    #ffffff;
            --surface-2:  #faf8f5;
            --border:     #e8e2d9;
            --border-hi:  #d4cbbd;
            --text:       #1a1714;
            --text-2:     #4a4540;
            --muted:      #9b9189;
            --accent:     #c17d3c;
            --accent-lo:  rgba(193,125,60,.1);
            --accent-2:   #8b4513;
            --green:      #2d7a4f;
            --green-lo:   rgba(45,122,79,.1);
            --amber:      #b8860b;
            --amber-lo:   rgba(184,134,11,.1);
            --red:        #c0392b;
            --red-lo:     rgba(192,57,43,.1);
            --blue:       #2563a8;
            --blue-lo:    rgba(37,99,168,.1);
            --radius:     12px;
            --mono:       'JetBrains Mono', monospace;
            --sans:       'Sora', sans-serif;
            --shadow-sm:  0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
            --shadow:     0 4px 16px rgba(0,0,0,.08), 0 1px 4px rgba(0,0,0,.04);
            --shadow-lg:  0 8px 32px rgba(0,0,0,.1), 0 2px 8px rgba(0,0,0,.06);
        }

        body {
            background: var(--bg);
            background-image:
                radial-gradient(circle at 20% 20%, rgba(193,125,60,.06) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(139,69,19,.04) 0%, transparent 50%);
            color: var(--text);
            font-family: var(--sans);
            min-height: 100vh;
            padding: 40px 32px;
        }

        .page-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 36px;
        }
        .header-icon {
            width: 44px; height: 44px;
            background: var(--accent);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(193,125,60,.3);
            flex-shrink: 0;
        }
        .header-text h1 { font-size: 24px; font-weight: 700; letter-spacing: -.5px; }
        .header-text .subtitle { font-size: 12px; color: var(--muted); font-family: var(--mono); margin-top: 2px; letter-spacing: .05em; }

        /* Filter Panel */
        .filter-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px 28px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }
        .filter-panel h2 {
            font-size: 11px; font-weight: 600; letter-spacing: .1em;
            text-transform: uppercase; color: var(--muted);
            margin-bottom: 18px;
            display: flex; align-items: center; gap: 8px;
        }
        .filter-panel h2::before {
            content: ''; display: inline-block;
            width: 16px; height: 2px;
            background: var(--accent); border-radius: 1px;
        }
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
            gap: 14px;
        }
        .filter-group { display: flex; flex-direction: column; gap: 6px; }
        .filter-group label { font-size: 11px; font-weight: 600; color: var(--text-2); letter-spacing: .06em; text-transform: uppercase; }
        .filter-group input,
        .filter-group select {
            background: var(--surface-2);
            border: 1.5px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: var(--sans);
            font-size: 13px;
            padding: 9px 12px;
            outline: none;
            transition: border-color .15s, box-shadow .15s;
            width: 100%;
            appearance: none;
        }
        .filter-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%239b9189' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 28px;
        }
        .filter-group input:focus,
        .filter-group select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(193,125,60,.12); }
        .filter-group input::placeholder { color: var(--muted); }
        .filter-actions { display: flex; align-items: center; gap: 10px; margin-top: 18px; }

        .btn {
            border: none; border-radius: 8px; cursor: pointer;
            font-family: var(--sans); font-size: 13px; font-weight: 600;
            padding: 9px 20px; transition: all .15s; letter-spacing: .01em;
        }
        .btn:active { transform: scale(.97); }
        .btn-primary { background: var(--accent); color: #fff; box-shadow: 0 2px 8px rgba(193,125,60,.25); }
        .btn-primary:hover { background: var(--accent-2); }
        .btn-ghost { background: transparent; border: 1.5px solid var(--border); color: var(--muted); }
        .btn-ghost:hover { border-color: var(--border-hi); color: var(--text-2); background: var(--surface-2); }

        /* Results bar */
        .results-bar {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 14px; min-height: 32px;
        }
        .results-count { font-size: 12px; color: var(--muted); font-family: var(--mono); }
        .results-count strong { color: var(--text-2); font-weight: 500; }
        .ordering-select {
            background: var(--surface);
            border: 1.5px solid var(--border);
            border-radius: 8px;
            color: var(--text-2);
            font-family: var(--sans); font-size: 12px; font-weight: 500;
            padding: 6px 28px 6px 12px;
            outline: none; cursor: pointer; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%239b9189' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 10px center;
            box-shadow: var(--shadow-sm);
        }

        /* Table */
        .table-wrap {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow-x: auto;
            box-shadow: var(--shadow);
        }
        table { border-collapse: collapse; width: 100%; min-width: 900px; }
        thead th {
            background: var(--surface-2);
            border-bottom: 1.5px solid var(--border);
            color: var(--muted);
            font-size: 11px; font-weight: 600;
            letter-spacing: .08em;
            padding: 13px 16px;
            text-align: left;
            text-transform: uppercase;
            white-space: nowrap;
        }
        tbody tr { border-bottom: 1px solid var(--border); transition: background .1s; }
        tbody tr:last-child { border-bottom: none; }
        tbody tr:hover { background: #fdf9f5; }
        tbody td { color: var(--text); font-size: 13px; padding: 14px 16px; vertical-align: top; }

        .order-id { color: var(--muted); font-family: var(--mono); font-size: 12px; font-weight: 500; }
        .customer-name { font-weight: 600; color: var(--text); }

        /* delivery info cell */
        .delivery-cell { display: flex; flex-direction: column; gap: 4px; min-width: 180px; }
        .delivery-phone {
            display: flex; align-items: center; gap: 5px;
            font-family: var(--mono); font-size: 12px; color: var(--text-2); font-weight: 500;
        }
        .delivery-city {
            display: inline-flex; align-items: center; gap: 4px;
            background: var(--green-lo); color: var(--green);
            border-radius: 4px; padding: 2px 8px;
            font-size: 11px; font-weight: 600;
            width: fit-content;
        }
        .delivery-address {
            font-size: 11px; color: var(--muted);
            line-height: 1.4;
            max-width: 220px;
        }

        /* copy button */
        .copy-btn {
            background: none; border: none; cursor: pointer;
            color: var(--muted); font-size: 11px; padding: 0;
            opacity: 0.6; transition: opacity .15s;
        }
        .copy-btn:hover { opacity: 1; color: var(--accent); }

        /* status badges */
        .badge {
            border-radius: 5px; display: inline-block;
            font-family: var(--mono); font-size: 10px; font-weight: 500;
            letter-spacing: .06em; padding: 3px 9px; text-transform: uppercase;
        }
        .badge-pending         { background: var(--amber-lo);  color: var(--amber); }
        .badge-payment_pending { background: var(--amber-lo);  color: var(--amber); }
        .badge-payment_failed  { background: var(--red-lo);    color: var(--red);   }
        .badge-confirmed       { background: var(--blue-lo);   color: var(--blue);  }
        .badge-processing      { background: var(--accent-lo); color: var(--accent);}
        .badge-shipped         { background: var(--blue-lo);   color: var(--blue);  }
        .badge-delivered       { background: var(--green-lo);  color: var(--green); }
        .badge-cancelled       { background: var(--red-lo);    color: var(--red);   }
        .badge-refunded        { background: rgba(0,0,0,.06);  color: var(--muted); }

        .status-select {
            border: none; cursor: pointer;
            font-family: var(--mono); font-size: 10px; font-weight: 500;
            letter-spacing: .06em; padding: 3px 20px 3px 9px;
            border-radius: 5px; outline: none; text-transform: uppercase;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 12 12'%3E%3Cpath fill='%239b9189' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 6px center;
        }
        .status-select option { background: #fff; color: #1a1714; font-family: 'Sora', sans-serif; }

        .items-list { display: flex; flex-direction: column; gap: 4px; }
        .item-pill {
            background: var(--surface-2); border: 1px solid var(--border);
            border-radius: 5px; color: var(--text-2);
            display: inline-block; font-size: 11px; font-weight: 500;
            padding: 2px 8px; white-space: nowrap;
        }
        .total-price { font-family: var(--mono); font-size: 13px; font-weight: 500; color: var(--green); }
        .date-cell { color: var(--muted); font-family: var(--mono); font-size: 11px; white-space: nowrap; }

        .state-row td { padding: 56px 16px; text-align: center; color: var(--muted); font-size: 13px; }
        .spinner {
            width: 18px; height: 18px;
            border: 2px solid var(--border); border-top-color: var(--accent);
            border-radius: 50%; display: inline-block;
            animation: spin .7s linear infinite;
            margin-right: 8px; vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Pagination */
        .pagination {
            display: flex; align-items: center; justify-content: space-between;
            margin-top: 18px; padding: 0 2px;
        }
        .page-info { color: var(--muted); font-family: var(--mono); font-size: 12px; }
        .page-btns { display: flex; gap: 8px; }
        .page-btn {
            background: var(--surface); border: 1.5px solid var(--border);
            border-radius: 8px; color: var(--text-2); cursor: pointer;
            font-family: var(--sans); font-size: 12px; font-weight: 500;
            padding: 7px 16px; transition: all .15s; box-shadow: var(--shadow-sm);
        }
        .page-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
        .page-btn:disabled { opacity: .35; cursor: default; }

        /* Toast */
        #toast {
            background: var(--text); border-radius: 10px;
            bottom: 28px; color: #fff; display: none;
            font-size: 13px; font-weight: 500;
            left: 50%; padding: 11px 22px; position: fixed;
            transform: translateX(-50%); z-index: 999;
            box-shadow: var(--shadow-lg); font-family: var(--sans);
        }
    </style>
</head>
<body>

<div class="page-header">
    <div class="header-icon">üå∏</div>
    <div class="header-text">
        <h1>Orders</h1>
        <div class="subtitle">admin ¬∑ bloom heaven</div>
    </div>
</div>

<!-- Filters -->
<div class="filter-panel">
    <h2>Filters</h2>
    <div class="filters-grid">
        <div class="filter-group">
            <label>Customer</label>
            <input type="text" id="filterCustomer" placeholder="username‚Ä¶">
        </div>
        <div class="filter-group">
            <label>Status</label>
            <select id="filterStatus">
                <option value="">All statuses</option>
                <option value="payment_pending">Payment Pending</option>
                <option value="payment_failed">Payment Failed</option>
                <option value="confirmed">Confirmed</option>
                <option value="processing">Processing</option>
                <option value="shipped">Shipped</option>
                <option value="delivered">Delivered</option>
                <option value="cancelled">Cancelled</option>
                <option value="refunded">Refunded</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Flower Name</label>
            <input type="text" id="filterFlower" placeholder="e.g. rose‚Ä¶">
        </div>
        <div class="filter-group">
            <label>Date From</label>
            <input type="date" id="filterDateFrom">
        </div>
        <div class="filter-group">
            <label>Date To</label>
            <input type="date" id="filterDateTo">
        </div>
        <div class="filter-group">
            <label>Min Total (‚Çπ)</label>
            <input type="number" id="filterTotalMin" placeholder="0" min="0" step="0.01">
        </div>
        <div class="filter-group">
            <label>Max Total (‚Çπ)</label>
            <input type="number" id="filterTotalMax" placeholder="any" min="0" step="0.01">
        </div>
    </div>
    <div class="filter-actions">
        <button class="btn btn-primary" id="applyFilters">Apply Filters</button>
        <button class="btn btn-ghost" id="clearFilters">Clear All</button>
    </div>
</div>

<!-- Results bar -->
<div class="results-bar">
    <span class="results-count" id="resultsCount">‚Äî</span>
    <select class="ordering-select" id="orderingSelect">
        <option value="-created_at">Newest first</option>
        <option value="created_at">Oldest first</option>
        <option value="-total_amount">Highest total</option>
        <option value="total_amount">Lowest total</option>
    </select>
</div>

<!-- Table -->
<div class="table-wrap">
    <table>
        <thead>
            <tr>
                <th>Order</th>
                <th>Customer</th>
                <th>Delivery Info</th>
                <th>Status</th>
                <th>Items</th>
                <th>Total</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody id="ordersBody">
            <tr class="state-row">
                <td colspan="7"><span class="spinner"></span> Loading‚Ä¶</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Pagination -->
<div class="pagination">
    <span class="page-info" id="pageInfo">‚Äî</span>
    <div class="page-btns">
        <button class="page-btn" id="btnPrev" disabled>‚Üê Prev</button>
        <button class="page-btn" id="btnNext" disabled>Next ‚Üí</button>
    </div>
</div>

<div id="toast"></div>

<script>
    const BASE_URL = 'http://127.0.0.1:8000/flowerapp';
    const PAGE_SIZE = 10;

    let state = { page: 1, totalCount: 0, next: null, previous: null };

    function getFilters() {
        return {
            customer:    document.getElementById('filterCustomer').value.trim(),
            status:      document.getElementById('filterStatus').value,
            flower_name: document.getElementById('filterFlower').value.trim(),
            date_from:   document.getElementById('filterDateFrom').value,
            date_to:     document.getElementById('filterDateTo').value,
            total_min:   document.getElementById('filterTotalMin').value.trim(),
            total_max:   document.getElementById('filterTotalMax').value.trim(),
            ordering:    document.getElementById('orderingSelect').value,
        };
    }

    function buildQueryString(filters, page) {
        const params = new URLSearchParams({ page });
        Object.entries(filters).forEach(([k, v]) => {
            if (v !== '' && v !== null && v !== undefined) params.append(k, v);
        });
        return params.toString();
    }

    async function fetchOrders(page = 1) {
        state.page = page;
        const filters = getFilters();
        const qs  = buildQueryString(filters, page);
        const url = `${BASE_URL}/api/v1/orders/?${qs}`;
        setLoading(true);

        const token = localStorage.getItem('access_token');
        try {
            const response = await fetch(url, {
                headers: { 'Accept': 'application/json', 'Authorization': `Bearer ${token}` }
            });
            if (response.status === 401) { window.location.href = '/flowerapp/signin/'; return; }
            if (!response.ok) { showToast(`Error ${response.status}`); setLoading(false); return; }

            const data = await response.json();
            state.totalCount = data.count;
            state.next       = data.next;
            state.previous   = data.previous;

            renderOrders(data.results);
            renderPagination();
            updateResultsCount();
            syncURL(filters, page);
        } catch (err) {
            showToast('Network error ‚Äî could not reach server.');
        }
        setLoading(false);
    }

    function renderOrders(orders) {
        const tbody = document.getElementById('ordersBody');
        tbody.innerHTML = '';

        if (!orders || orders.length === 0) {
            tbody.innerHTML = '<tr class="state-row"><td colspan="7">No orders found.</td></tr>';
            return;
        }

        orders.forEach(order => {
            const itemsHtml = (order.items || []).map(item =>
                `<span class="item-pill">üå∏ ${escHtml(item.flower_name)} √ó${item.quantity}</span>`
            ).join('');

            let total = parseFloat(order.total_amount);
            if (isNaN(total)) {
                total = (order.items || []).reduce(
                    (s, i) => s + parseFloat(i.unit_price || 0) * (i.quantity || 1), 0
                );
            }

            const dateStr = order.order_date || order.created_at
            ? new Date(order.order_date || order.created_at).toLocaleString('en-IN', {
                day:      '2-digit',
                month:    'short',
                year:     'numeric',
                hour:     '2-digit',
                minute:   '2-digit',
                hour12:   true,
                timeZone: 'Asia/Kolkata',
            })
            : '‚Äî';

            const statusKey = (order.status || '').toLowerCase();
            const phone     = order.customer_phone   || '‚Äî';
            const city      = order.customer_city    || '‚Äî';
            const address   = order.customer_address || '‚Äî';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="order-id">#${order.id}</span></td>
                <td><span class="customer-name">${escHtml(order.customer_username || '‚Äî')}</span></td>
                <td>
                    <div class="delivery-cell">
                        <div class="delivery-phone">
                            üìû ${escHtml(phone)}
                            <button class="copy-btn" onclick="copyText('${escHtml(phone)}')" title="Copy phone">‚ßâ</button>
                        </div>
                        <div class="delivery-city">üìç ${escHtml(city)}</div>
                        <div class="delivery-address">${escHtml(address)}</div>
                    </div>
                </td>
                <td>
                    <select class="status-select badge badge-${statusKey}"
                            data-order-id="${order.id}"
                            onchange="updateStatus(this)">
                        <option value="payment_pending" ${statusKey==='payment_pending'?'selected':''}>Payment Pending</option>
                        <option value="payment_failed"  ${statusKey==='payment_failed' ?'selected':''}>Payment Failed</option>
                        <option value="confirmed"       ${statusKey==='confirmed'      ?'selected':''}>Confirmed</option>
                        <option value="processing"      ${statusKey==='processing'     ?'selected':''}>Processing</option>
                        <option value="shipped"         ${statusKey==='shipped'        ?'selected':''}>Shipped</option>
                        <option value="delivered"       ${statusKey==='delivered'      ?'selected':''}>Delivered</option>
                        <option value="cancelled"       ${statusKey==='cancelled'      ?'selected':''}>Cancelled</option>
                        <option value="refunded"        ${statusKey==='refunded'       ?'selected':''}>Refunded</option>
                    </select>
                </td>
                <td><div class="items-list">${itemsHtml || '‚Äî'}</div></td>
                <td><span class="total-price">‚Çπ${total.toFixed(2)}</span></td>
                <td><span class="date-cell">${dateStr}</span></td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function updateStatus(selectEl) {
        const orderId   = selectEl.dataset.orderId;
        const newStatus = selectEl.value;
        const token     = localStorage.getItem('access_token');
        try {
            const response = await fetch(`${BASE_URL}/api/v1/orders/${orderId}/`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ status: newStatus }),
            });
            if (response.ok) {
                selectEl.className = `status-select badge badge-${newStatus}`;
                showToast(`Order #${orderId} ‚Üí ${newStatus}`);
            } else {
                showToast('Failed to update status');
                fetchOrders(state.page);
            }
        } catch (err) {
            showToast('Network error');
            fetchOrders(state.page);
        }
    }

    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => showToast('Copied!'));
    }

    function renderPagination() {
        const totalPages = Math.ceil(state.totalCount / PAGE_SIZE) || 1;
        document.getElementById('btnPrev').disabled = !state.previous;
        document.getElementById('btnNext').disabled = !state.next;
        document.getElementById('pageInfo').textContent = `Page ${state.page} of ${totalPages}`;
    }

    function updateResultsCount() {
        const c = state.totalCount;
        document.getElementById('resultsCount').innerHTML =
            `<strong>${c}</strong> order${c !== 1 ? 's' : ''} found`;
    }

    function setLoading(yes) {
        if (yes) {
            document.getElementById('ordersBody').innerHTML =
                '<tr class="state-row"><td colspan="7"><span class="spinner"></span> Loading‚Ä¶</td></tr>';
            document.getElementById('btnPrev').disabled = true;
            document.getElementById('btnNext').disabled = true;
        }
    }

    function syncURL(filters, page) {
        const params = new URLSearchParams({ page });
        Object.entries(filters).forEach(([k, v]) => { if (v !== '') params.append(k, v); });
        window.history.replaceState({}, '', `${window.location.pathname}?${params.toString()}`);
    }

    function restoreFromURL() {
        const params = new URLSearchParams(window.location.search);
        const set = (id, key) => { if (params.get(key)) document.getElementById(id).value = params.get(key); };
        set('filterCustomer', 'customer');
        set('filterStatus',   'status');
        set('filterFlower',   'flower_name');
        set('filterDateFrom', 'date_from');
        set('filterDateTo',   'date_to');
        set('filterTotalMin', 'total_min');
        set('filterTotalMax', 'total_max');
        set('orderingSelect', 'ordering');
        return parseInt(params.get('page') || '1', 10);
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.style.display = 'block';
        setTimeout(() => { t.style.display = 'none'; }, 3500);
    }

    function escHtml(str) {
        return String(str)
            .replace(/&/g, '&amp;').replace(/</g, '&lt;')
            .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    document.getElementById('applyFilters').addEventListener('click', () => fetchOrders(1));
    document.getElementById('clearFilters').addEventListener('click', () => {
        ['filterCustomer','filterFlower','filterDateFrom','filterDateTo',
         'filterTotalMin','filterTotalMax'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('filterStatus').value   = '';
        document.getElementById('orderingSelect').value = '-created_at';
        fetchOrders(1);
    });
    document.getElementById('orderingSelect').addEventListener('change', () => fetchOrders(1));
    document.getElementById('btnPrev').addEventListener('click', () => { if (state.previous) fetchOrders(state.page - 1); });
    document.getElementById('btnNext').addEventListener('click', () => { if (state.next) fetchOrders(state.page + 1); });
    document.querySelectorAll('.filter-group input').forEach(el => {
        el.addEventListener('keydown', e => { if (e.key === 'Enter') fetchOrders(1); });
    });

    const startPage = restoreFromURL();
    fetchOrders(startPage);
</script>
</body>
</html>